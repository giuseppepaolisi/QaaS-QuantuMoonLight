# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
- master #elenco di rami per cui il push attiva un esecuzione

pool:
  vmImage: ubuntu-latest #pool in cui vengono eseguiti i processi della pipeline

stages:
#    - stage: 'BuildStage'
#      displayName: 'Build Stage'
    
    - stage: 'TestStage'
      displayName: 'Test Stage'
      pool:
          vImage: ubuntu-latest
      jobs:
        - job: 'Test_job'
          strategy:
           parallel: 1
          steps:
            - task: Bash@3
              inputs:
                targetType: inline
                script: |
                 source activate quantumoonlight
                 cd ~/git-projects/QaaS-QuantuMoonLight/src/source/cassificazioneDataset
                 pytest
                 cd ~/git-projects/QaaS-QuantuMoonLight/src/source/gestione
                 pytest
    - stage: "DeployStage"
      displayName: "Deploy Stage"
      jobs:
      - deployment: "QuantuMoonLight_deploy"
        displayName: "Deploy Job"
        continueOnError: true
        pool:
            vImage: ubuntu-latest
        environment: qmlDevOps.QuantuMoonLight-VM
        strategy:
            runOnce:
             preDeploy:
               steps:
                 - script: |
                    pwd
                    cd ~/git-projects/QaaS-QuantuMoonLight
                    git stash push -u -m "stash effettuato"
                    git pull --rebase
             deploy:
               steps:
                - task: Bash@3
                  inputs:
                    targetType: inline
                    script: |
                      echo "starting deployment script run"
                      source activate quantumoonlight
                      echo "Ambiente attivato"
                      sudo systemctl start gunicorn
                      echo "Servizio attivo"
             on:
               failure:
                 steps:
                   - script: |
                      echo "This is a failure"
                      systemctl status gunicorn.service
               success:
                  steps :
                    - script: echo "Success"
                     #steps:
                    #- script: sudo kill -9 $(sudo lsof -t -i:5000)
                    #- script: git pull
                    #- script: source activate quantumoonlight; cd ~; cd git-projects/QaaS-QuantuMoonLight; flask run --host=0.0.0.0
